{% extends 'base.html' %}

{% block title %}Dashboard - Sistema de Inventario TI{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'inventario:crear_producto' %}" class="btn btn-sm btn-primary">
                <i class="fas fa-plus me-1"></i>Nuevo Producto
            </a>
            <a href="{% url 'inventario:crear_movimiento' %}" class="btn btn-sm btn-success">
                <i class="fas fa-exchange-alt me-1"></i>Nuevo Movimiento
            </a>
        </div>
    </div>
</div>

<!-- Estadísticas -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
                            Total Productos
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-white">{{ total_productos }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-boxes fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card success h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
                            Categorías
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-white">{{ total_categorias }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tags fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card info h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
                            Movimientos
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-white">{{ total_movimientos }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exchange-alt fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card warning h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
                            Stock Bajo
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-white">{{ productos_stock_bajo }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos y contenido -->
<div class="row">
    <!-- Gráfico de productos por categoría -->
    <div class="col-xl-8 col-lg-7">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-pie me-2"></i>Productos por Categoría
                </h6>
            </div>
            <div class="card-body">
                <canvas id="categoriaChart" width="100%" height="40"></canvas>
            </div>
        </div>
    </div>

    <!-- Valor total del inventario -->
    <div class="col-xl-4 col-lg-5">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-dollar-sign me-2"></i>Valor Total del Inventario
                </h6>
            </div>
            <div class="card-body text-center">
                <h2 class="text-success mb-3">${{ valor_total|floatformat:2 }}</h2>
                <p class="text-muted">Valor estimado del inventario actual</p>
            </div>
        </div>
    </div>
</div>

<!-- Movimientos recientes -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-history me-2"></i>Movimientos Recientes
                </h6>
                <a href="{% url 'inventario:lista_movimientos' %}" class="btn btn-sm btn-primary">
                    Ver Todos
                </a>
            </div>
            <div class="card-body">
                {% if movimientos_recientes %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Tipo</th>
                                <th>Cantidad</th>
                                <th>Usuario</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for movimiento in movimientos_recientes %}
                            <tr>
                                <td>
                                    <a href="{% url 'inventario:detalle_producto' movimiento.producto.id %}" 
                                       class="text-decoration-none">
                                        {{ movimiento.producto.nombre }}
                                    </a>
                                </td>
                                <td>
                                    <span class="badge {% if movimiento.tipo_movimiento.es_entrada %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ movimiento.tipo_movimiento.nombre }}
                                    </span>
                                </td>
                                <td>{{ movimiento.cantidad }}</td>
                                <td>{{ movimiento.usuario.get_full_name }}</td>
                                <td>{{ movimiento.fecha_movimiento|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <span class="badge bg-info">
                                        {{ movimiento.producto.get_estado_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No hay movimientos recientes</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función para crear el gráfico
function crearGraficoCategoria() {
    const canvas = document.getElementById('categoriaChart');
    if (!canvas) {
        console.error('Canvas no encontrado');
        return;
    }
    
    // Destruir gráfico existente si existe
    if (window.categoriaChart) {
        window.categoriaChart.destroy();
    }
    
    const ctx = canvas.getContext('2d');
    const categoriaData = JSON.parse('{{ productos_por_categoria|safe }}');
    
    if (!categoriaData || categoriaData.length === 0) {
        console.warn('No hay datos de categorías disponibles');
        return;
    }
    
    // Crear nuevo gráfico
    window.categoriaChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: categoriaData.map(item => item.nombre),
            datasets: [{
                label: 'Productos por Categoría',
                data: categoriaData.map(item => item.total_productos),
                backgroundColor: '#3498db',
                borderColor: '#2980b9',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Productos por Categoría'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Ejecutar cuando el DOM esté listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', crearGraficoCategoria);
} else {
    crearGraficoCategoria();
}
</script>
{% endblock %} 