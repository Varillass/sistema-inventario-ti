{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión Avanzada de Cuentas - Sistema de Inventario TI{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-chart-line text-primary me-2"></i>
                Gestión Avanzada de Cuentas
            </h1>
            <p class="text-muted">Panel de control y monitoreo de cuentas</p>
        </div>
        <div>
            <a href="{% url 'inventario:lista_cuentas' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver
            </a>
            <a href="{% url 'inventario:crear_cuenta' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Nueva Cuenta
            </a>
        </div>
    </div>

    <!-- Estadísticas generales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-white-50">Total Cuentas</h6>
                            <h3 class="text-white mb-0">{{ total_cuentas }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-shield fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-white-50">Activas</h6>
                            <h3 class="text-white mb-0">{{ cuentas_activas }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-white-50">Vencidas</h6>
                            <h3 class="text-white mb-0">{{ cuentas_vencidas }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-white-50">Costo Mensual</h6>
                            <h3 class="text-white mb-0">${{ costo_total_mensual|floatformat:2 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Cuentas por tipo -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Cuentas por Tipo
                    </h5>
                </div>
                <div class="card-body">
                    {% if cuentas_por_tipo %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Cantidad</th>
                                        <th>Porcentaje</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tipo in cuentas_por_tipo %}
                                        <tr>
                                            <td>
                                                {% for tipo_choice in tipos_cuenta %}
                                                    {% if tipo_choice.0 == tipo.tipo_cuenta %}
                                                        {{ tipo_choice.1 }}
                                                    {% endif %}
                                                {% endfor %}
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ tipo.total }}</span>
                                            </td>
                                            <td>
                                                {% widthratio tipo.total total_cuentas 100 %}%
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-chart-pie fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No hay datos disponibles</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Cuentas próximas a vencer -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Próximas a Vencer (30 días)
                    </h5>
                </div>
                <div class="card-body">
                    {% if cuentas_proximo_vencimiento %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Cuenta</th>
                                        <th>Tipo</th>
                                        <th>Vence</th>
                                        <th>Días</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cuenta in cuentas_proximo_vencimiento %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'inventario:detalle_cuenta' cuenta.id %}" class="text-decoration-none">
                                                    {{ cuenta.nombre }}
                                                </a>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ cuenta.get_tipo_cuenta_display }}</span>
                                            </td>
                                            <td>{{ cuenta.fecha_vencimiento|date:"d/m/Y" }}</td>
                                            <td>
                                                {% if cuenta.dias_vencimiento <= 7 %}
                                                    <span class="badge bg-danger">{{ cuenta.dias_vencimiento }}</span>
                                                {% elif cuenta.dias_vencimiento <= 15 %}
                                                    <span class="badge bg-warning">{{ cuenta.dias_vencimiento }}</span>
                                                {% else %}
                                                    <span class="badge bg-info">{{ cuenta.dias_vencimiento }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <p class="text-success">¡Excelente! No hay cuentas próximas a vencer</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Cuentas vencidas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Cuentas Vencidas
                    </h5>
                </div>
                <div class="card-body">
                    {% if cuentas_vencidas_lista %}
                        <div class="table-responsive">
                            <table class="table table-hover" id="cuentasVencidasTable">
                                <thead>
                                    <tr>
                                        <th>Cuenta</th>
                                        <th>Tipo</th>
                                        <th>Email</th>
                                        <th>Asignado a</th>
                                        <th>Venció</th>
                                        <th>Días Vencida</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cuenta in cuentas_vencidas_lista %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'inventario:detalle_cuenta' cuenta.id %}" class="text-decoration-none">
                                                    {{ cuenta.nombre }}
                                                </a>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ cuenta.get_tipo_cuenta_display }}</span>
                                            </td>
                                            <td>{{ cuenta.email }}</td>
                                            <td>
                                                {% if cuenta.personal_asignado %}
                                                    {{ cuenta.personal_asignado.get_full_name }}
                                                {% else %}
                                                    <span class="text-muted">Sin asignar</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ cuenta.fecha_vencimiento|date:"d/m/Y" }}</td>
                                            <td>
                                                <span class="badge bg-danger">{{ cuenta.dias_vencimiento|abs }}</span>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="{% url 'inventario:editar_cuenta' cuenta.id %}" 
                                                       class="btn btn-sm btn-outline-primary" title="Renovar">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <a href="{% url 'inventario:detalle_cuenta' cuenta.id %}" 
                                                       class="btn btn-sm btn-outline-info" title="Ver detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h5 class="text-success">¡Perfecto!</h5>
                            <p class="text-muted">No hay cuentas vencidas en el sistema</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Inicializar DataTable para cuentas vencidas
    $('#cuentasVencidasTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
        },
        "pageLength": 10,
        "order": [[5, "desc"]], // Ordenar por días vencida
        "autoWidth": false,
        "responsive": true
    });
});
</script>
{% endblock %} 